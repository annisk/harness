
.defaults: &defaults
  environment:
    scala_image: actionml/scala:2.11
    compose_version: 1.22.0
    SDK_VERBOSE: yes


version: 2
jobs:
  test:
    <<: *defaults

    docker:
      - image: ${scala_image}

    steps:
      - checkout
      - restore_cache:
          keys:
            - sbt-maven-{{ .Branch }}

      - run:
          name: test and compile
          command: cd ./rest-server && sbt -batch ++$SCALA_VERSION test compile

      - save_cache:
          key: sbt-maven-{{ .Branch }}
          paths:
            - /root/.sbt
            - /root/.ivy2

      # - run: mkdir -p workspace
      # - run: echo "Hello, world!" > workspace/echo-output
      
      # Persist the specified paths (workspace/echo-output) into the workspace for use in downstream job. 
    #   - persist_to_workspace:
    #       # Must be an absolute path, or relative path from working_directory. This is a directory on the container which is 
    # # taken to be the root directory of the workspace.
    #       root: workspace
    #       # Must be relative path from root
    #       paths:
    #         - echo-output

  downstream:
    docker:
      - image: stackfeed/alpine

    steps:
      - run: /bin/true

      # - attach_workspace:
      #     # Must be absolute path or relative path from working_directory
      #     at: /tmp/workspace

      # - run: |
      #     if [[ `cat /tmp/workspace/echo-output` == "Hello, world!" ]]; then
      #       echo "It worked!";
      #     else
      #       echo "Nope!"; exit 1
      #     fi

workflows:
  version: 2

  integration:
    jobs:
      - test
      - downstream:
          requires:
            - test
